name: ğŸš€ Deploy React App to Cloudflare Pages ğŸŒ©ï¸

on:
  workflow_dispatch:  # ğŸ§‘â€ğŸ’» Manual deploy only

jobs:
  deploy:
    # Cloud-hosted option:
    # runs-on: ubuntu-latest  # ğŸ§ Use this for GitHub-hosted runners
    runs-on: self-hosted      # ğŸ¡ Dark Ice local runner (macOS, safer for testing)

    env:
      CI: false  # ğŸš« Prevent warnings from failing the build

    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v3

      # ğŸ§° Ensure required Node.js version is available (Wrangler requires â‰¥ 18)
      - name: ğŸ§° Setup Node.js 18
        uses: actions/setup-node@v3
        with:
          node-version: '18'

      - name: ğŸ“¦ Install Dependencies
        run: npm install

      - name: ğŸ—ï¸ Build React App
        run: npm run build

      # âš ï¸ Local install of wrangler to avoid EACCES permission issues on self-hosted runners
      - name: âš™ï¸ Install Cloudflare Wrangler Locally
        run: npm install wrangler --save-dev

      - name: ğŸŒ Deploy to Cloudflare Pages with Wrangler
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
        run: |
          echo "ğŸš€ Deploying to Cloudflare Pages using local wrangler..."

          # ğŸŒ©ï¸ Local install of wrangler avoids global permission issues
          npx wrangler pages deploy build \
            --project-name=${{ secrets.CLOUDFLARE_PROJECT_NAME }} \
            --branch=${{ github.ref_name }} \
            --commit-hash=${{ github.sha }} \
            --commit-message="${{ github.event.head_commit.message }}"

          echo "âœ… Deployment completed successfully!"

      - name: ğŸ” Test Brevo API Connectivity
        run: |
          echo "ğŸ” Testing /testconnections endpoint..."
          STATUS_CODE=$(curl -s -o /dev/null -w "%{http_code}" https://${{ vars.CLOUDFLARE_PAGES_DOMAIN }}/testconnections)

          if [ "$STATUS_CODE" -eq 200 ]; then
            echo "âœ… Test connection passed!"
          else
            echo "âŒ Test connection failed with status $STATUS_CODE"
            exit 1
          fi
